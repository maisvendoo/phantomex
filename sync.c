/*-----------------------------------------------------------------------------
 *
 * 		Synchronization primitives
 * 		(c) maisvendoo, 01.08.2013
 *
 *---------------------------------------------------------------------------*/

#include	"sync.h"


bool	choosing[N_THREADS] = {0};
int		number[N_THREADS] = {0};

/*-----------------------------------------------------------------------------
 *
 *---------------------------------------------------------------------------*/
bool mutex_get(mutex_t* mutex, bool wait)
{
	bool old_value = true;

	do
	{
		asm volatile ("xchg (,%1,), %0":"=a"(old_value):"b"(mutex), "a"(old_value));

	} while (old_value && wait);

	return !old_value;
}

/*-----------------------------------------------------------------------------
 *
 *---------------------------------------------------------------------------*/
void mutex_release(mutex_t* mutex)
{
	*mutex = false;
}

/*-----------------------------------------------------------------------------
 *
 *---------------------------------------------------------------------------*/
void lock(int i)
{
	int j = 0;
	choosing[i] = true;

	for (j = 0; j < N_THREADS; j++)
	{
		if (number[j] >= number[i])
		{
			number[i] = number[j];
		}
	}

	number[i]++;

	choosing[i] = false;

	for (j = 0; j < N_THREADS; j++)
	{
		while (choosing[j]);

		while ( (number[j] != 0) && ( (number[j] < number[i]) || ( (number[j] == number[i]) && (j < i) ) ) );
	}
}

/*-----------------------------------------------------------------------------
 *
 *---------------------------------------------------------------------------*/
void unlock(int i)
{
	number[i] = 0;
}
